---
import Popup from './KPopup.Template.astro';
import { parseModuleValues } from 'redaxo-adapter';
import { type PopupData } from '../../../popup/adapter';

interface Props {
    popups: PopupData[];
    PopupComponent: any;
}

const props = Astro.props;
const { popups, PopupComponent }: Props = props;
---

{
    popups?.map(
        (popup, idx) =>
            popup.slice &&
            (popup.visible || popup.showReopenButton) && (
                <div data-popup data-popup-idx={idx}>
                    <PopupComponent
                        visible={popup.visible}
                        showReopenButton={popup.showReopenButton}
                        slice={{
                            ...popup.slice,
                            values: parseModuleValues(popup.slice.values),
                            media: parseModuleValues(popup.slice.media),
                            link: parseModuleValues(popup.slice.link),
                            linkList: parseModuleValues(popup.slice.linkList),
                            mediaList: parseModuleValues(popup.slice.mediaList),
                        }}
                    />
                </div>
            ),
    )
}

<script>
    document.querySelectorAll('[data-popup]').forEach((popup) => {
        const idx = Number.parseInt(popup.getAttribute('data-popup-idx')!);
        const close = popup.querySelector('[data-popup-close]');
        const popupBody = popup.querySelector('[data-popup-body]')!;
        const popupReopenButton = popup.querySelector('[data-popup-reopen]');
        close?.addEventListener('click', () => {
            popupBody.classList.add('hidden');
            popupReopenButton?.classList.remove('hidden');
            setClickedData(idx, true);
        });
        popupReopenButton?.addEventListener('click', () => {
            popupBody.classList.remove('hidden');
            popupReopenButton?.classList.add('hidden');
            setClickedData(idx, false);
        });
    });

    function setClickedData(idx: number, closed: boolean) {
        const cookieData: string = document.cookie
            .split('; ')
            .find((row) => row.startsWith('popup_data='))
            ?.split('=')[1]!;
        const cookieParsed = JSON.parse(decodeURIComponent(cookieData));
        cookieParsed[idx].closed = closed;
        document.cookie =
            'popup_data=' + encodeURIComponent(JSON.stringify(cookieParsed));
    }
</script>
