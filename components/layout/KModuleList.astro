---
import KModuleWrapper from './KModuleWrapper.astro';
import { parseModuleValues } from 'redaxo-adapter';
import type { Article, Clang } from 'redaxo-adapter';

interface Props {
    article: Article;
    isFooterModuleList?: boolean;
    clang: Clang;
    ModuleWrapperComponent?: any;
    moduleMapping: Map<string, any>;
    [key: string]: any;
}

const {
    isFooterModuleList,
    moduleMapping,
    article,
    ModuleWrapperComponent = KModuleWrapper,
    ...rest
} = Astro.props;

article.slices = article.slices.map((slice) => ({
    ...slice,
    values: parseModuleValues(slice.values),
    media: parseModuleValues(slice.media),
    link: parseModuleValues(slice.link),
    linkList: parseModuleValues(slice.linkList),
    mediaList: parseModuleValues(slice.mediaList),
}));
---

{
    article.slices.map((slice) => {
        const Component = moduleMapping.get(slice.moduleCode);
        if (!Component) {
            console.error(
                `No component found for moduleCode: "${slice.moduleCode}"`,
            );
            return null;
        }

        const isLast =
            slice.id === article.slices[article.slices.length - 1].id;
        const isFirst = slice.id === article.slices[0].id;

        return (
            <ModuleWrapperComponent
                isFooterModule={isFooterModuleList}
                {slice}
                {article}
                {...rest}
                {isFirst}
                {isLast}
            >
                <Component
                    {slice}
                    {article}
                    isFooterModule={isFooterModuleList}
                    {...rest}
                />
            </ModuleWrapperComponent>
        );
    })
}
